@{
    ViewData["Title"] = "Cálculo de Costos de Producción";
}

<section class="hero">
    <div class="hero-content">
        <div class="hero-eyebrow"><span></span> Plataforma textil inteligente</div>
        <h1>Gestioná tus costos con precisión y visuales de nueva generación.</h1>
        <p>
            Carga insumos, fichas técnicas y consumos en segundos mientras la plataforma automatiza cálculos,
            identifica oportunidades de ahorro y te guía con analíticas claras.
        </p>
        <div class="hero-cta">
            <a class="btn btn-primary" href="#upload-section">Cargar archivos</a>
            <a class="btn btn-outline-light" href="#workflow">Ver cómo funciona</a>
        </div>
    </div>
    <div class="hero-visual">
        <div class="hero-glow"></div>
        <img src="~/img/hero-illustration.svg" alt="Ilustración futurista sobre análisis textil" />
    </div>
</section>

<section class="stats-grid">
    <div class="stat-card">
        <strong>+48%</strong>
        <span>más velocidad en conciliación de costos</span>
    </div>
    <div class="stat-card">
        <strong>24/7</strong>
        <span>monitor de procesos con notificaciones en vivo</span>
    </div>
    <div class="stat-card">
        <strong>99.3%</strong>
        <span>precisión promedio en detección de variaciones</span>
    </div>
    <div class="stat-card">
        <strong>15min</strong>
        <span>para pasar de datos crudos a reporte final</span>
    </div>
</section>

<section class="section-title">
    <div>
        <h2>Un sistema modular, pensado para el día a día</h2>
        <p>Interfaz moderna con microinteracciones y componentes reutilizables.</p>
    </div>
    <a class="accent-link" href="#upload-section">Empezar ahora</a>
</section>

<section class="features-grid">
    <article class="feature-card">
        <div class="icon-pill">
            <i class="bi bi-hdd-stack"></i>
        </div>
        <h3>Imports drag & drop</h3>
        <p>Subí múltiples archivos Excel con validaciones instantáneas y feedback visual en tiempo real.</p>
    </article>
    <article class="feature-card">
        <div class="icon-pill">
            <i class="bi bi-bar-chart-steps"></i>
        </div>
        <h3>Insights automáticos</h3>
        <p>Detectamos desvíos de costos y sugerimos ajustes a partir de tu histórico de consumos.</p>
    </article>
    <article class="feature-card">
        <div class="icon-pill">
            <i class="bi bi-lightning-charge"></i>
        </div>
        <h3>Microinteracciones</h3>
        <p>Animaciones suaves guían cada acción, optimizando accesibilidad y claridad en cada paso.</p>
    </article>
    <article class="feature-card">
        <div class="icon-pill">
            <i class="bi bi-moon-stars"></i>
        </div>
        <h3>Modo dual</h3>
        <p>Estética glassmorphism con tema claro/oscuro, preparada para sesiones prolongadas.</p>
    </article>
</section>

<section id="workflow" class="workflow-section">
    <div class="section-title">
        <div>
            <h2>Cómo integramos tus datos</h2>
            <p>Experiencia end-to-end desde la carga hasta el reporte consolidado.</p>
        </div>
    </div>
    <div class="workflow-steps">
        <article class="workflow-step" data-step="Paso 1">
            <h4>Cargá tus fuentes</h4>
            <p>Arrastrá Excel de telas, avíos y consumos. Validamos formatos y detectamos inconsistencias.</p>
        </article>
        <article class="workflow-step" data-step="Paso 2">
            <h4>Procesamiento en vivo</h4>
            <p>Visualizá barras de progreso animadas con actualizaciones en tiempo real vía SignalR.</p>
        </article>
        <article class="workflow-step" data-step="Paso 3">
            <h4>Insights accionables</h4>
            <p>Obtén tablas interactivas con costos por metro/unidad y exportá resultados listos para producción.</p>
        </article>
    </div>
</section>

<section id="upload-section" class="card">
    <div class="card-header">
        Cargar Archivos de Costos
    </div>
    <div class="card-body">
        <form asp-action="Index" method="post" enctype="multipart/form-data">
            <div class="file-upload-wrapper">
                <div class="file-upload-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-upload" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10.5a.5.5 0 0 1 0-1h2.188C13.938 10 15 8.981 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-4.242 3.153A4.98 4.98 0 0 0 1.55 8H1.5a.5.5 0 0 1 0-1h.05a4.98 4.98 0 0 0 1.95-3.846A5.53 5.53 0 0 1 4.406 1.342z"/>
                        <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg>
                </div>
                <label for="archivosExcel" class="file-upload-label">
                    Arrastra tus archivos aquí o haz clic para seleccionar
                </label>
                <input type="file" name="archivosExcel" id="archivosExcel" multiple accept=".xls,.xlsx" />
            </div>
            <div id="file-name-display" class="text-center"></div>
            <div class="btn-container">
                <button type="submit" class="btn btn-primary">Procesar Archivos</button>
            </div>
        </form>
    </div>
</section>

<div id="progress-container" class="mt-3"></div>

@if (ViewData["Telas"] != null || ViewData["Avios"] != null)
{
    <div class="results-card">
        <h3 class="mb-3">Resultados del Procesamiento</h3>
        <div class="results-body">
            @if (ViewData["Telas"] != null)
            {
                var telas = (List<Zenko.Models.TelaExcel>)ViewData["Telas"];
                <h4>Telas Encontradas</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Costo por Metro</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var tela in telas)
                            {
                                <tr>
                                    <td>@tela.Codigo</td>
                                    <td>@tela.CostoPorMetro.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (ViewData["Avios"] != null)
            {
                var avios = (List<Zenko.Models.AvioExcel>)ViewData["Avios"];
                <h4>Avíos Encontrados</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Costo por Unidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var avio in avios)
                            {
                                <tr>
                                    <td>@avio.Codigo</td>
                                    <td>@avio.CostoUnidad.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const form = document.querySelector('form');
        const progressContainer = document.getElementById('progress-container');

        if (window.signalR) {
            const connection = new signalR.HubConnectionBuilder().withUrl('/processingHub').build();

            connection.on('ProgressUpdated', (id, porcentaje, estado) => {
                const bar = document.getElementById(`bar-${id}`);
                if (bar) {
                    bar.style.width = porcentaje + '%';
                    bar.textContent = `${estado} ${porcentaje}%`;
                }
            });

            connection.start().catch(error => console.error('Error al iniciar SignalR:', error));
        } else {
            console.warn('SignalR no está disponible. Continuando sin actualizaciones en tiempo real.');
        }

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            fetch('/Home/Index', {
                method: 'POST',
                body: formData
            })
                .then(resp => resp.json())
                .then(data => {
                    data.forEach(p => {
                        const wrapper = document.createElement('div');
                        wrapper.innerHTML = `<div>${p.name}</div><div class="progress"><div id="bar-${p.id}" class="progress-bar" style="width:0%">0%</div></div>`;
                        progressContainer.appendChild(wrapper);
                    });
                });
        });

        document.getElementById('archivosExcel').addEventListener('change', function (e) {
            const fileInput = e.target;
            const display = document.getElementById('file-name-display');

            if (fileInput.files && fileInput.files.length > 0) {
                if (fileInput.files.length === 1) {
                    display.textContent = 'Archivo seleccionado: ' + fileInput.files[0].name;
                } else {
                    display.textContent = fileInput.files.length + ' archivos seleccionados';
                }
            } else {
                display.textContent = '';
            }
        });
    </script>
}
